<!DOCTYPE html>
<html>
<head>
<title>QUBeditotron3000</title>

<script type="text/javascript">


let apiBaseUrl = null; 
let currentRequest = null;
let service_info = null;

fetch('./service_info.json')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        service_info = data;
        apiBaseUrl = service_info.proxy_url;

        // now the data is gathered enable the buttons
        document.querySelectorAll(".operation").forEach(button => button.disabled = false);

    })
    .catch(error => {
        console.error(`Error loading JSON: ${error.message}`);
    });

function isValidContent(value) {
    if (!value || value.trim().length === 0) {
        return false;
    }
    if (value.length > 7388) {
        alert("Content exceeds the maximum allowed length of 7388 characters.");
        return false;
    }
    return true;
}

function makeRequest(service_name, callback) {
    if (apiBaseUrl == null){
        // blocks the make request function untill after service is connected to
        console.error("API Base URL is not defined. Ensure service_info.JSON is loaded.");
        return
    }
    if (service_name == null){
        // blocks the make request function from running if no service name is provided
        console.error("Service name is not provided.");
        return
    }

    if (!isValidContent(content.value)) {
        // blocks the make request function if content is empty or only contains spaces
        return alert("Text is invalid. Ensure it is not empty or just spaces.");
    }

    // disable the text area to prevent further editing
    document.getElementById("content").disabled = true;

    if (currentRequest) currentRequest.abort();
    
    let xhttp = new XMLHttpRequest();

    currentRequest = xhttp;

    const url = `${apiBaseUrl}/api/${service_name}?text=${encodeURIComponent(content.value)}`;

    let currentUrl = window.location.href;
    let queryString = currentUrl.split('?')[1];

    xhttp.onreadystatechange = () => {
        if (xhttp.readyState == 4) {
            currentRequest = null;

            // re enable the text area to prevent further editing
            document.getElementById("content").disabled = false;

            if (xhttp.status == 200) {
                try {
                    const response = JSON.parse(xhttp.response);
                    if (response.error) {
                        alert(response.string);
                    } else {
                        callback(response.answer);
                    }
                } 
                catch (e) {
                    output.value = `Error parsing: ${e}`;
                }
            } else {
                output.value = `Error: ${xhttp.status} - ${xhttp.statusText}`;
            }
        }
    };
    xhttp.open("GET", url);
    xhttp.send();
}

function addEntry(identifier, content) {
    const addUrl = `${apiBaseUrl}/api/database/${encodeURIComponent(identifier)}/new?text=${encodeURIComponent(content)}`;

    return fetch(addUrl, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.message);
            }
            alert("Text saved successfully.");
        });
}

function updateEntry(identifier, content) {
    const deleteUrl = `${apiBaseUrl}/api/database/${encodeURIComponent(identifier)}/delete`;
    fetch(deleteUrl, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.log(data.message)
                throw new Error(data.message);
            }
            return addEntry(identifier, content)
        });
}


function getEntries() {
    const getUrl = `${apiBaseUrl}/api/database/ids`;

    return fetch(getUrl, { method: 'GET' })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.message); // If error exists in the data, throw it
            }
            return data; // Return the data if no error
        })
        .catch(error => {
            console.error('There was an error with the fetch operation:', error);
        });
    }

function saveToDatabase() {
    const identifier = document.getElementById("identifier").value;
    const content = document.getElementById("content").value;

    if (!identifier || identifier.trim().length === 0) {
        alert("Identifier is required.");
        return;
    }

    if (!isValidContent(content)) {
        return;
    }

    getEntries()
        .then(data => {
            if (data && data.identifiers && data.identifiers.includes("hello")) {
                updateEntry(identifier, content)
            } else if (data && data.identifiers && !data.identifiers.includes("hello")) {
                addEntry(identifier, content)
            }
        })
        .catch(error => {
            console.error("Error getting entries:", error);
        });

}


// disable all buttons until the relevant data is gathered
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".operation").forEach(button => button.disabled = true);
});


const wordCount = () => makeRequest(service_info.functions_info.wordCount, result => output.value = result);
const charCount = () => makeRequest(service_info.functions_info.charCount, result => output.value = result);
const spellCheck = () => makeRequest(service_info.functions_info.spellCheck, result => output.value = result);
const fullStopCounter = () => makeRequest(service_info.functions_info.fullStopCounter, result => output.value = result);
const averageWordLength = () => makeRequest(service_info.functions_info.averageWordLength, result => output.value = result);
const countPalindrome = () => makeRequest(service_info.functions_info.countPalindrome, result => output.value = result);

</script>

<style type="text/css">
body  {
    font-size: 150%;
    background-color: #7FBEAB;
    font-family: monospace;
}

#logo
{
    font-family: Calibri, sans-serif;
    font-weight: lighter;
    color: #85877C;
    margin: 0.5em;
}

#editor
{
    text-align: center;
    margin-top: 1em;
}

#output {
    font-size: 100%;
    padding: 0.2em;
    margin: 0.2em;
    font-family: monospace;
    letter-spacing: 0.1em;
}

#content {
    font-size: 100%;
    padding: 0.2em;
    margin: 0.2em;
    font-family: monospace;
    letter-spacing: 0.1em;
}

#identifier {
    font-size: 100%;
    padding: 0.2em;
    margin: 0.2em;
    font-family: monospace;
    letter-spacing: 0.1em;
}

.operation {
    border: solid rgb(0, 0, 0) 1px;
    background-color: #85877C;
    padding: 1.5em;
    margin: 1em;
    width: 14em;
}
</style>

</head>
<body>
<div id="editor">
    <div id="logo">
        QUBeditotron3000
    </div>
    <div>
        <input rows="1" cols="40" type="text" id="identifier" placeholder="Enter identifier..." />
    </div>
    <div>
        <textarea rows="5" cols="40" id="content">It was the best of cloud, it was the worst of cloud...</textarea>
    </div>
    <div>
        <input type="text" id="output" readonly="1" value="" />
    </div>
    <div>
        <button class="operation" onclick="wordCount();">Word Count</button>
        <button class="operation" onclick="charCount();">Character Count</button>        
    </div>
    <div>
        <button class="operation" onclick="spellCheck();">Spell Check</button>
        <button class="operation" onclick="fullStopCounter();">FullStops Count</button>
    </div>
    <div>
        <button class="operation" onclick="countPalindrome()">Palindrome Count</button>
        <button class="operation" onclick="averageWordLength()">Averge Word Length</button>
    </div>
    <div>
        <button class="operation" onclick="saveToDatabase();">Save to Database</button>
    </div>
</div>
</body>


</html>
